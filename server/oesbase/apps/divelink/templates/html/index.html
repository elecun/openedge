{% extends "html/base.html" %} 
{% load static %}

{% block css %}
  <link rel="stylesheet" href="{% static 'plugins/jsgrid/jsgrid.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/jsgrid/jsgrid-theme.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/bootstrap-toggle/css/bootstrap-toggle.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}"></script>
  <link rel="stylesheet" href="{% static 'plugins/datatables/jquery.dataTables.min.css' %}"></script>
  <style>

    /* display alignment with padding */
    .content {
      padding: 15px 7px !important;
      background-color:rgb(6, 6, 55) !important;
    }

    /* side menu button */
    .btn-app-side {
      margin: 0 0 10px 0px !important;
      min-width: 110px;
  }
    </style>
{% endblock %}

{% block javascript %}

<script type="text/javascript" src="{% static 'plugins/jsgrid/jsgrid.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/bootstrap-toggle/js/bootstrap-toggle.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/echarts/echarts.min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/datatables/datatables.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/shortcut.js' %}"></script>
<script type="text/javascript" src="{% static 'js/paho-mqtt-min.js' %}"></script>
<script type="text/javascript" src="{% static 'plugins/chart.js/chart.js' %}"></script>



<script type="text/javascript">

var _chart_update_timer_id = null;

let mqtt_client_id = "dive-client-"+parseInt(Math.random()*10000, 10);
var mqtt_client = new Paho.Client("127.0.0.1", 8083, mqtt_client_id);
var mqtt_connected = false;
mqtt_client.onConnectionLost = mqtt_onConnectionLost;
mqtt_client.onMessageArrived = mqtt_onMessageArrived;
mqtt_client.connect({onSuccess:mqtt_onConnect, onFailure:mqtt_onFailure, reconnect: true, useSSL:false});

var sound_received = new Audio("{% static 'sound/received.mp3' %}");


function play_notify(){  sound_received.play(); }

/* MQTT Connection event callback */
function mqtt_onConnect(){
  mqtt_connected = true;
  mqtt_client.subscribe("divelink/#");
  $.notify("Successfully connected to system!!", {className: "success",position:"bottom left"});
}

/* MQTT Failure event callback */
function mqtt_onFailure(){
  $.notify("System connection has a problem", {className: "error",position:"bottom left"});
}

/* MQTT Connection lost event callback */
function mqtt_onConnectionLost(responseObject){
    mqtt_connected = false;
    $.notify("System connection is lost", {className: "error",position:"bottom left"});
}

/* chart update function */
async function chart_update(ref_id){
  request_chart_data_ref(ref_id);
}

var prev_emergency = false;

/* MQTT message arrived event callback */
function mqtt_onMessageArrived(message){
    const payload = JSON.parse(message.payloadString);
    
    /* status data update */
    switch(message.topic){
      case "divelink/rsu/lora": { 
        const data = JSON.parse(message.payloadString);
        play_notify();
        update_layers(data.lsid, data.lsid, [data.longitude, data.latitude], "-", "-");
        // document.getElementById('edit_status_temperature_1').value = data.location;
        // document.getElementById('edit_status_temperature_2').value = data.lsid;
        // document.getElementById('edit_status_temperature_3').value = data.ldid;
        // $("#edit_status_temperature_1").trigger('change');
        // $("#edit_status_temperature_2").trigger('change');
        // $("#edit_status_temperature_3").trigger('change');
      } break;

      case "divelink/rsu/m64": {
        const data = JSON.parse(message.payloadString);
        console.log(data);
      } break;

      
      
    }

}


</script>

{% endblock %}

{% block contents %}

  <!-- for notification -->
  {% include 'html/modal_notify.html' %}
  <!-- for error -->
  {% include 'html/modal_error.html' %}


<!-- main contents -->
<div class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12">
        {% include 'html/view.html' %}
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block post_javascript %}
<script type="text/javascript">

</script>
{% endblock %}