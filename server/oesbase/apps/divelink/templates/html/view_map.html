
{% load static %}

<style>
    #map { height: 532px; }
</style>

<link rel="stylesheet" href="{% static 'plugins/leafletjs/leaflet.css' %}">
<script type="text/javascript" src="{% static 'plugins/leafletjs/leaflet.js' %}"></script>

<div class="row m-0">
    <div class="col-sm-12 p-1">

        <div id="map"></div>

    </div>
</div>


<style>

.map-label {
  position: absolute;
  bottom: 0;left: -50%;
  display: flex;
  flex-direction: column;
  text-align: center;
  margin-bottom: 40px;
}

.map-label-content {
  order: 1;
  position: relative; left: -50%;
  background-color: #fff;
  border-radius: 5px;
  border-width: 2px;
  border-style: solid;
  border-color: #444;
  padding: 3px;
  white-space: nowrap;
}

.map-label-arrow {
  order: 2;
  width: 0px; height: 0px; left: 50%;
  border-style: solid;
  border-color: #444 transparent transparent transparent;
  border-width: 10px 6px 0 6px; 
  margin-left: -6px;
}

.map-label.redborder > .map-label-content {
  border-color: #e00;
}
.map-label.redborder > .map-label-arrow {
  border-top-color: #e00;
}

.map-label.redbackground > .map-label-content {
  white-space: default;
  color: #fff;
  background-color: #e00;
}


</style>

<script language="javascript">

  var layers = new Map();
  var map = L.map('map').setView([37.4939, 129.1572], 14);  //default map

  var markers = new Map(); //marker layer container

  /* Getting Current Location Info. */
  map.on('contextmenu', (e) => {
    alert("Location (Lat, Lng) : " + e.latlng.lat + ", " + e.latlng.lng)
  });  

  /* Update marker on map */
  function update_layer(loraid, longitude, latitude){

    if(markers.has(loraid)){
      console.log("gps location : ", longitude, latitude);
      markers.get(loraid).setLatLng(L.latLng(String(latitude), String(longitude))).update();
      markers.get(loraid)._popup.setContent("<b> LoRa ID : "+loraid+"</b><br><li>Longitude : "+longitude+"<br><li>Latitude : "+latitude+"<p>", {'maxWidth':250});
      
      const sound_notify = document.getElementById('check_sound_notify').checked;
      if(sound_notify){
        play_notify();
      }
    }
    else {
      var marker = new L.marker([latitude, longitude],{alt: loraid});
      markers.set(loraid, marker);
      markers.get(loraid).bindPopup("<b> LoRa ID : "+loraid+"</b><br><li>Longitude : "+longitude+"<br><li>Latitude : "+latitude+"<p>", {'maxWidth':250}).addTo(map).openPopup();
      map.addLayer(markers.get(loraid));
    }

  }


  /* page load */
  window.addEventListener('DOMContentLoaded', function(){
    //check the map is already initialized
    // var container = L.DomUtil.get('map');
    // if(container != null){
    //   container._leaflet_id = null;
    // }
      
    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    //const v = L.marker([37.48264, 129.16009],{alt: name}).bindPopup("<b>RSU-02</b><br><li>Depth : 37m<br><li>Temperature : 22째C<p><a class='btn btn-sm btn-block btn-success' href='#'' role='button'>View History</a>").addTo(map);
    /*layers.set(1, 
    L.marker([37.48264, 129.16009],{alt: name}).bindPopup("<b>RSU-02</b><br><li>Depth : 37m<br><li>Temperature : 22째C<p><a class='btn btn-sm btn-block btn-success' href='#'' role='button'>View History</a>").addTo(map)
    );*/

    //update_layers(1, "test", [37.48264, 129.16009], 1, 1, map);

    //layers.get(1).openPopup();
    //layer.openPopup();

    //L.marker([37.4939, 129.1572],{alt: 'RSU-01'}).bindTooltip("RSU-01", { permanent: true, direction: 'right' }).addTo(map);
    //L.marker([37.48264, 129.16009],{alt: 'RSU-02'}).bindTooltip("RSU-02", { permanent: true, direction: 'right' }).addTo(map);
    //L.marker([37.4939, 129.1572],{alt: 'RSU-01'}).bindPopup("<b>RSU-01</b><br><li>Depth : 40m<br><li>Temperature : 20째C<p><a class='btn btn-sm btn-block btn-success' href='#'' role='button'>View History</a>").addTo(map);
    //L.marker([37.48264, 129.16009],{alt: 'RSU-02'}).bindPopup("<b>RSU-02</b><br><li>Depth : 37m<br><li>Temperature : 22째C<p><a class='btn btn-sm btn-block btn-success' href='#'' role='button'>View History</a>").addTo(map);
    //L.marker([37.4939, 129.1572], {icon: L.divIcon({ iconSize:null, html:'<div class="map-label"><div class="map-label-content">RSU-01</div></div>' })}).addTo(map);
    //L.marker([37.48264, 129.16009], {icon: L.divIcon({ iconSize:null, html:'<div class="map-label"><div class="map-label-content">RSU-02</div></div>' })}).addTo(map);


    //L.circle([37.49, 129.1597], { color: 'red', fillColor: '#f03', fillOpacity: 0.1, radius: 1000}).addTo(map);



      });
    
</script>
